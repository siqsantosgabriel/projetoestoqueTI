<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estoque TI - Privado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        /* Estilo da Tela de Login */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; z-index: 9999; display: flex;
            align-items: center; justify-content: center; color: white;
        }
        .card-login { width: 350px; padding: 20px; border-radius: 10px; background: white; color: #333; }
        .baixo-estoque { background-color: #fff5f5 !important; border-left: 5px solid #dc3545; }
        .btn-acao { width: 40px; height: 40px; border-radius: 8px; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="card-login shadow-lg text-center">
        <h4 class="mb-3">ðŸ”’ Acesso Restrito</h4>
        <p class="text-muted small">Digite a senha da equipe de TI</p>
        <input type="password" id="senhaInput" class="form-control mb-3" placeholder="Senha">
        <button onclick="verificarSenha()" class="btn btn-primary w-100">Entrar no Sistema</button>
        <p id="erroLogin" class="text-danger mt-2 small" style="display:none;">Senha incorreta!</p>
    </div>
</div>

<div id="conteudoSistema" style="display:none;" class="container py-5">
    <div class="card shadow border-0">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <span>ðŸ“¦ ESTOQUE TI - REAL TIME</span>
            <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#modalCadastro">+ Novo Item</button>
        </div>
        <div class="card-body">
            <input type="text" id="inputBusca" class="form-control mb-3" placeholder="Filtrar produtos...">
            
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Produto</th>
                            <th>Qtd</th>
                            <th>MÃ­n.</th>
                            <th class="text-center">AÃ§Ãµes</th>
                            <th class="text-end">Excluir</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaCorpo"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCadastro" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5>Novo Produto</h5></div>
            <div class="modal-body">
                <input type="text" id="nomeNovo" class="form-control mb-2" placeholder="Nome">
                <input type="number" id="qtdNovo" class="form-control mb-2" placeholder="Quantidade">
                <input type="number" id="minNovo" class="form-control mb-2" placeholder="Alerta MÃ­nimo">
            </div>
            <div class="modal-footer">
                <button onclick="salvarNovoProduto()" class="btn btn-success w-100">Cadastrar</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA4lwZX_GwaTuMAjmfZB3N-zaF869DV6rE",
        authDomain: "projetoestoqueti.firebaseapp.com",
        databaseURL: "https://projetoestoqueti-default-rtdb.firebaseio.com",
        projectId: "projetoestoqueti",
        storageBucket: "projetoestoqueti.firebasestorage.app",
        messagingSenderId: "787336391551",
        appId: "1:787336391551:web:021e81574a1e0bd4dd084a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const estoqueRef = ref(db, 'estoque/');

    // LOGIN SIMPLES
    const SENHA_CORRETA = "prvl123"; // ALTERE AQUI A SENHA DA EQUIPE

    window.verificarSenha = () => {
        const senha = document.getElementById('senhaInput').value;
        if(senha === SENHA_CORRETA) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('conteudoSistema').style.display = 'block';
        } else {
            document.getElementById('erroLogin').style.display = 'block';
        }
    };

    // RENDERIZAR
    onValue(estoqueRef, (snapshot) => {
        const dados = snapshot.val();
        const corpo = document.getElementById('tabelaCorpo');
        corpo.innerHTML = '';
        const filtro = document.getElementById('inputBusca').value.toLowerCase();

        for (let id in dados) {
            const p = dados[id];
            if (p.nome.toLowerCase().includes(filtro)) {
                const alerta = p.quantidade <= p.estoqueMinimo ? 'baixo-estoque' : '';
                corpo.innerHTML += `
                    <tr class="${alerta}">
                        <td><strong>${p.nome}</strong></td>
                        <td><span class="badge bg-dark">${p.quantidade}</span></td>
                        <td><small>${p.estoqueMinimo}</small></td>
                        <td class="text-center">
                            <button onclick="movimentar('${id}', 1)" class="btn btn-outline-success btn-sm btn-acao">+</button>
                            <button onclick="movimentar('${id}', -1)" class="btn btn-outline-danger btn-sm btn-acao">-</button>
                        </td>
                        <td class="text-end">
                            <button onclick="deletarProduto('${id}', '${p.nome}')" class="btn btn-link text-danger p-0">
                                <i class="bi bi-trash3-fill"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }
        }
    });

    // FUNÃ‡Ã•ES GLOBAIS
    window.salvarNovoProduto = () => {
        const nome = document.getElementById('nomeNovo').value;
        if(!nome) return alert("Nome obrigatÃ³rio!");
        push(estoqueRef, {
            nome: nome,
            quantidade: parseInt(document.getElementById('qtdNovo').value) || 0,
            estoqueMinimo: parseInt(document.getElementById('minNovo').value) || 0
        });
        bootstrap.Modal.getInstance(document.getElementById('modalCadastro')).hide();
        document.getElementById('nomeNovo').value = '';
    };

    window.movimentar = (id, valor) => {
        const itemRef = ref(db, `estoque/${id}`);
        onValue(itemRef, (s) => {
            const novaQtd = (s.val().quantidade || 0) + valor;
            update(itemRef, { quantidade: Math.max(0, novaQtd) });
        }, { onlyOnce: true });
    };

    window.deletarProduto = (id, nome) => {
        if(confirm(`Tem certeza que deseja excluir o produto "${nome}"?`)) {
            remove(ref(db, `estoque/${id}`));
        }
    };

    document.getElementById('inputBusca').addEventListener('input', () => {
        onValue(estoqueRef, (s) => {}, {onlyOnce: true}); // ForÃ§a refresh visual
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
