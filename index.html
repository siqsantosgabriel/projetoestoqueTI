<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESTOQUE TI - SD</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-body: #f8f9fa; --sidebar-bg: #212529; --card-bg: #ffffff;
            --primary-color: #0d6efd; --text-main: #333; --accent: #ffd700;
        }
        [data-bs-theme="dark"] {
            --bg-body: #121212; --sidebar-bg: #1a1a1a; --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
        }

        body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; transition: 0.3s; overflow-x: hidden; }
        
        /* Layout Sidebar */
        .wrapper { display: flex; width: 100%; align-items: stretch; }
        #sidebar { min-width: 250px; max-width: 250px; background: var(--sidebar-bg); color: #fff; transition: all 0.3s; min-height: 100vh; }
        #content { width: 100%; padding: 30px; }

        .sidebar-header { padding: 20px; background: rgba(0,0,0,0.1); text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-link { color: rgba(255,255,255,0.7); padding: 15px 20px; display: block; text-decoration: none; transition: 0.2s; }
        .nav-link:hover { background: rgba(255,255,255,0.1); color: var(--accent); }
        .nav-link.active { color: var(--accent); border-left: 4px solid var(--accent); background: rgba(255,255,255,0.05); }

        /* Cards Estilizados */
        .card { background-color: var(--card-bg); border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 10px; }
        
        /* Alertas de Estoque */
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .row-baixo { border-left: 5px solid #ffc107 !important; }
        .row-zero { border-left: 5px solid #dc3545 !important; background-color: rgba(220, 53, 69, 0.05); }

        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { width: 380px; padding: 40px; border-radius: 20px; background: #fff; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        
        .theme-toggle { position: fixed; top: 20px; right: 20px; z-index: 1000; cursor: pointer; font-size: 24px; color: var(--primary-color); }
    </style>
</head>
<body data-bs-theme="light">

<div id="loginOverlay">
    <div class="login-card text-center">
        <div class="mb-4"><i class="bi bi-box-seam text-primary" style="font-size: 3rem;"></i></div>
        <h2 class="fw-bold mb-4" style="color: #333;">ESTOQUE TI</h2>
        <input type="text" id="userInput" class="form-control form-control-lg mb-3" placeholder="Usu√°rio">
        <input type="password" id="senhaInput" class="form-control form-control-lg mb-4" placeholder="Senha">
        <button onclick="verificarLogin()" class="btn btn-primary btn-lg w-100 shadow">ENTRAR</button>
        <p id="erroLogin" class="text-danger mt-3 small" style="display:none;">Credenciais incorretas.</p>
    </div>
</div>

<div class="wrapper" id="conteudoSistema" style="display:none;">
    <nav id="sidebar">
        <div class="sidebar-header">
            <h4 class="fw-bold mb-0">TI - SD</h4>
            <small class="text-muted">v2.0 Premium</small>
        </div>
        <ul class="list-unstyled mt-4">
            <li><a href="#" class="nav-link active"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a></li>
            <li><a href="#" onclick="toggleLogs()" class="nav-link"><i class="bi bi-clock-history me-2"></i> Hist√≥rico</a></li>
            <li class="admin-only"><a href="#" data-bs-toggle="modal" data-bs-target="#modalGestaoUsuarios" class="nav-link"><i class="bi bi-people me-2"></i> Equipe</a></li>
            <li class="admin-only"><a href="#" onclick="exportarCSV()" class="nav-link text-success"><i class="bi bi-file-earmark-arrow-down me-2"></i> Exportar CSV</a></li>
            <hr class="mx-3 opacity-25">
            <li><a href="#" data-bs-toggle="modal" data-bs-target="#modalMinhaSenha" class="nav-link"><i class="bi bi-person-lock me-2"></i> Minha Senha</a></li>
            <li><a href="." class="nav-link text-danger"><i class="bi bi-box-arrow-right me-2"></i> Sair</a></li>
        </ul>
    </nav>

    <div id="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold mb-0">Dashboard</h4>
                <p class="text-muted mb-0">Bem-vindo, <span id="userLogado" class="text-primary fw-bold"></span></p>
            </div>
            <div class="d-flex gap-2">
                <i class="bi bi-brightness-high-fill theme-toggle" onclick="toggleTheme()" id="themeIcon"></i>
                <button class="btn btn-warning fw-bold px-4" data-bs-toggle="modal" data-bs-target="#modalCadastro">+ Novo Item</button>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card p-3">
                    <div class="stat-icon bg-primary-subtle text-primary"><i class="bi bi-boxes"></i></div>
                    <h6 class="text-muted mb-1">Total de Itens</h6>
                    <h3 class="fw-bold mb-0" id="dashTotal">0</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <div class="stat-icon bg-danger-subtle text-danger"><i class="bi bi-exclamation-triangle"></i></div>
                    <h6 class="text-muted mb-1">Cr√≠ticos/Zerados</h6>
                    <h3 class="fw-bold mb-0" id="dashAlerta">0</h3>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-3">
                    <h6 class="fw-bold mb-3">Tend√™ncia de Sa√≠das (Top 5)</h6>
                    <div style="height: 120px;"><canvas id="meuGrafico"></canvas></div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-body p-0">
                <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-light">
                    <h6 class="fw-bold mb-0">Invent√°rio de Hardware</h6>
                    <input type="text" id="inputBusca" class="form-control form-control-sm w-25 shadow-sm" placeholder="üîç Buscar...">
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Produto</th>
                                <th>Saldo</th>
                                <th>M√≠nimo</th>
                                <th class="text-center">Opera√ß√µes</th>
                                <th class="text-end pe-4 admin-only">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaCorpo"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="secaoLogs" style="display:none;" class="mt-4">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between">
                    <h6 class="fw-bold mb-0">Hist√≥rico Recente</h6>
                    <input type="text" id="buscaLog" class="form-control form-control-sm w-25" placeholder="Filtrar log...">
                </div>
                <div class="list-group list-group-flush" id="listaLogs" style="max-height: 250px; overflow-y: auto;"></div>
                <div class="card-footer text-center admin-only">
                    <button onclick="limparHistorico()" class="btn btn-sm btn-link text-danger">Zerar Hist√≥rico</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalGestaoUsuarios" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content border-0">
        <div class="modal-header bg-dark text-white"><h5>Gest√£o de Equipe</h5></div>
        <div class="modal-body">
            <div class="row g-2 mb-4 p-3 bg-light rounded">
                <div class="col-md-4"><input type="text" id="novoUserLogin" class="form-control" placeholder="Login"></div>
                <div class="col-md-4"><input type="text" id="novoUserSenha" class="form-control" placeholder="Senha"></div>
                <div class="col-md-4"><button onclick="cadastrarUsuario()" class="btn btn-primary w-100">Adicionar Membro</button></div>
            </div>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead><tr><th>Usu√°rio</th><th>Senha</th><th class="text-end">A√ß√µes</th></tr></thead>
                    <tbody id="tabelaUsuariosAdmin"></tbody>
                </table>
            </div>
        </div>
    </div></div>
</div>

<div class="modal fade" id="modalMinhaSenha" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Mudar Senha</h5></div><div class="modal-body"><input type="password" id="novaSenhaPessoal" class="form-control" placeholder="Nova Senha"></div><div class="modal-footer"><button onclick="salvarMinhaSenha()" class="btn btn-primary w-100">Atualizar</button></div></div></div></div>
<div class="modal fade" id="modalEntrada" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content"><div class="modal-header bg-success text-white"><h5>Entrada</h5></div><div class="modal-body"><input type="hidden" id="idEntrada"><input type="number" id="qtdEntrada" class="form-control" placeholder="Quantidade"></div><div class="modal-footer"><button onclick="confirmarEntrada()" class="btn btn-success w-100">Gravar</button></div></div></div></div>
<div class="modal fade" id="modalSaida" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5>Baixa no Estoque</h5></div><div class="modal-body"><input type="hidden" id="idSaida"><input type="number" id="qtdSaida" class="form-control mb-2" placeholder="Qtd"><input type="text" id="osSaida" class="form-control mb-2" placeholder="N¬∫ da OS"><input type="text" id="colabSaida" class="form-control" placeholder="Recebedor"></div><div class="modal-footer"><button onclick="confirmarSaida()" class="btn btn-danger w-100">Confirmar Sa√≠da</button></div></div></div></div>
<div class="modal fade" id="modalCadastro" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning"><h5>Novo Ativo de TI</h5></div><div class="modal-body"><input type="text" id="nomeNovo" class="form-control mb-2" placeholder="Nome (Ex: Monitor Dell 24')"><input type="number" id="qtdNovo" class="form-control mb-2" placeholder="Saldo Inicial"><input type="number" id="minNovo" class="form-control mb-2" placeholder="Ponto de Ressuprimento"></div><div class="modal-footer"><button onclick="salvarNovoProduto()" class="btn btn-dark w-100">Cadastrar</button></div></div></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA4lwZX_GwaTuMAjmfZB3N-zaF869DV6rE",
        authDomain: "projetoestoqueti.firebaseapp.com",
        databaseURL: "https://projetoestoqueti-default-rtdb.firebaseio.com",
        projectId: "projetoestoqueti",
        storageBucket: "projetoestoqueti.firebasestorage.app",
        messagingSenderId: "787336391551",
        appId: "1:787336391551:web:021e81574a1e0bd4dd084a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const estoqueRef = ref(db, 'estoque/');
    const logsRef = ref(db, 'logs/');
    const usersRef = ref(db, 'usuarios/');

    let dadosAtuais = {}, logsAtuais = {}, usuariosAtuais = {};
    let userLogado = "";
    let chartInstance = null;

    // --- LOGIN ---
    onValue(usersRef, s => {
        usuariosAtuais = s.val() || {};
        const corpoAdmin = document.getElementById('tabelaUsuariosAdmin');
        corpoAdmin.innerHTML = '';
        Object.keys(usuariosAtuais).forEach(u => {
            corpoAdmin.innerHTML += `<tr><td>${u}</td><td><code>***</code></td><td class="text-end">
                <button onclick="prepararEdicao('${u}', '${usuariosAtuais[u]}')" class="btn btn-sm btn-outline-dark me-1">Editar</button>
                <button onclick="removerUsuario('${u}')" class="btn btn-sm btn-outline-danger ${u==='brunosantos'?'disabled':''}">X</button>
            </td></tr>`;
        });
    });

    window.verificarLogin = () => {
        const u = document.getElementById('userInput').value.toLowerCase().trim();
        const p = document.getElementById('senhaInput').value;
        if(usuariosAtuais[u] === p || (u === "brunosantos" && p === "prvl123")) {
            userLogado = u;
            document.getElementById('userLogado').innerText = u;
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('conteudoSistema').style.display = 'flex';
            if(u === "brunosantos") document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
        } else { document.getElementById('erroLogin').style.display = 'block'; }
    };

    // --- DASHBOARD & RENDERING ---
    function renderizarGrafico() {
        const ctx = document.getElementById('meuGrafico').getContext('2d');
        const counts = {};
        Object.values(logsAtuais).forEach(l => { if(l.tipo === 'SA√çDA') counts[l.prod] = (counts[l.prod] || 0) + parseInt(l.qtd); });
        const labels = Object.keys(counts).sort((a,b) => counts[b] - counts[a]).slice(0, 5);
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'Sa√≠das', data: labels.map(l => counts[l]), backgroundColor: '#ffd700', borderRadius: 4 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
        });
    }

    function render() {
        const corpo = document.getElementById('tabelaCorpo');
        const lista = document.getElementById('listaLogs');
        const f = document.getElementById('inputBusca').value.toLowerCase();
        corpo.innerHTML = ''; lista.innerHTML = '';
        let tot = 0, alertCount = 0;

        Object.keys(dadosAtuais).forEach(id => {
            const p = dadosAtuais[id]; tot++;
            const zero = p.quantidade <= 0;
            const baixo = p.quantidade <= p.estoqueMinimo;
            if(baixo) alertCount++;
            if(p.nome.toLowerCase().includes(f)) {
                corpo.innerHTML += `<tr class="${zero ? 'row-zero' : (baixo ? 'row-baixo' : '')}">
                    <td class="ps-4 fw-semibold">${p.nome}</td>
                    <td><span class="badge ${zero ? 'bg-danger' : (baixo ? 'bg-warning text-dark' : 'bg-success')}">${p.quantidade}</span></td>
                    <td><small class="text-muted">${p.estoqueMinimo}</small></td>
                    <td class="text-center">
                        <button onclick="abrirEntrada('${id}')" class="btn btn-sm btn-outline-success"><i class="bi bi-plus-lg"></i></button>
                        <button onclick="abrirSaida('${id}')" class="btn btn-sm btn-outline-danger mx-1"><i class="bi bi-dash-lg"></i></button>
                    </td>
                    <td class="text-end pe-4 admin-only" style="display:${userLogado==='brunosantos'?'table-cell':'none'}">
                        <button onclick="del('${id}')" class="btn btn-sm text-muted"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>`;
            }
        });
        document.getElementById('dashTotal').innerText = tot;
        document.getElementById('dashAlerta').innerText = alertCount;
        
        Object.keys(logsAtuais).reverse().forEach(id => {
            const l = logsAtuais[id];
            lista.innerHTML += `<div class="list-group-item d-flex justify-content-between align-items-center">
                <div><b>${l.prod}</b> <span class="text-muted">(${l.tipo})</span><br><small>Por: ${l.user} | OS: ${l.os || '-'}</small></div>
                <div class="text-end"><span class="badge rounded-pill bg-light text-dark">${l.qtd} unid</span><br><small class="text-muted">${l.data}</small></div>
            </div>`;
        });
        renderizarGrafico();
    }

    // --- OPERA√á√ïES ---
    window.toggleTheme = () => {
        const b = document.body;
        const current = b.getAttribute('data-bs-theme');
        const next = current === 'light' ? 'dark' : 'light';
        b.setAttribute('data-bs-theme', next);
        document.getElementById('themeIcon').className = next === 'light' ? 'bi bi-brightness-high-fill theme-toggle' : 'bi bi-moon-stars-fill theme-toggle';
        render();
    };

    window.toggleLogs = () => { const s = document.getElementById('secaoLogs'); s.style.display = s.style.display==='none'?'block':'none'; };
    
    // Fun√ß√µes Operacionais Padr√£o
    onValue(estoqueRef, s => { dadosAtuais = s.val() || {}; render(); });
    onValue(logsRef, s => { logsAtuais = s.val() || {}; render(); });
    document.getElementById('inputBusca').addEventListener('input', render);

    window.abrirEntrada = id => { document.getElementById('idEntrada').value = id; new bootstrap.Modal('#modalEntrada').show(); };
    window.confirmarEntrada = () => {
        const id = document.getElementById('idEntrada').value;
        const q = parseInt(document.getElementById('qtdEntrada').value);
        update(ref(db, `estoque/${id}`), { quantidade: (dadosAtuais[id].quantidade || 0) + q });
        push(logsRef, { tipo: 'ENTRADA', prod: dadosAtuais[id].nome, qtd: q, user: userLogado, data: new Date().toLocaleDateString() });
        bootstrap.Modal.getInstance('#modalEntrada').hide();
    };
    window.abrirSaida = id => { document.getElementById('idSaida').value = id; new bootstrap.Modal('#modalSaida').show(); };
    window.confirmarSaida = () => {
        const id = document.getElementById('idSaida').value;
        const q = parseInt(document.getElementById('qtdSaida').value);
        if(dadosAtuais[id].quantidade < q) return alert("Saldo insuficiente");
        update(ref(db, `estoque/${id}`), { quantidade: dadosAtuais[id].quantidade - q });
        push(logsRef, { tipo: 'SA√çDA', prod: dadosAtuais[id].nome, qtd: q, os: document.getElementById('osSaida').value, colab: document.getElementById('colabSaida').value, user: userLogado, data: new Date().toLocaleDateString() });
        bootstrap.Modal.getInstance('#modalSaida').hide();
    };
    window.salvarNovoProduto = () => {
        push(estoqueRef, { nome: document.getElementById('nomeNovo').value, quantidade: parseInt(document.getElementById('qtdNovo').value) || 0, estoqueMinimo: parseInt(document.getElementById('minNovo').value) || 0 });
        bootstrap.Modal.getInstance('#modalCadastro').hide();
    };
    window.cadastrarUsuario = () => { set(ref(db, `usuarios/${document.getElementById('novoUserLogin').value.toLowerCase()}`), document.getElementById('novoUserSenha').value); };
    window.removerUsuario = u => { if(confirm("Remover?")) remove(ref(db, `usuarios/${u}`)); };
    window.salvarMinhaSenha = () => { set(ref(db, `usuarios/${userLogado}`), document.getElementById('novaSenhaPessoal').value); alert("Senha alterada!"); };
    window.del = id => { if(confirm("Excluir?")) remove(ref(db, `estoque/${id}`)); };
    window.limparHistorico = () => { if(confirm("Zerar logs?")) remove(logsRef); };
    window.exportarCSV = () => {
        let csv = 'sep=,\nTipo,Produto,Quantidade,OS,Responsavel,Data\n';
        Object.values(logsAtuais).forEach(l => csv += `${l.tipo},${l.prod},${l.qtd},${l.os||''},${l.user},${l.data}\n`);
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob(["\ufeff" + csv], { type: 'text/csv' })); a.download = 'estoque_sd.csv'; a.click();
    };
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
