<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estoque TI - Real Time</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; }
        .baixo-estoque { background-color: #ffe5e5 !important; border-left: 5px solid #d9534f; }
        .card-header { background: #2c3e50; color: white; font-weight: bold; }
        .btn-movimentacao { width: 100px; }
        .badge-qtd { font-size: 1.1rem; padding: 0.5em 0.8em; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="card shadow border-0">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>ðŸ“¦ CONTROLE DE ESTOQUE - EQUIPE TI PRVL</span>
            <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#modalCadastro">+ Cadastrar Produto</button>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col">
                    <input type="text" id="inputBusca" class="form-control" placeholder="ðŸ” Pesquisar produto por nome...">
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Produto</th>
                            <th>Qtd. Atual</th>
                            <th>Estoque MÃ­n.</th>
                            <th class="text-center">AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaCorpo">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCadastro" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Item no InventÃ¡rio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Nome do Produto</label>
                    <input type="text" id="nomeNovo" class="form-control" placeholder="Ex: Teclado MecÃ¢nico">
                </div>
                <div class="mb-3">
                    <label class="form-label">Quantidade Inicial</label>
                    <input type="number" id="qtdNovo" class="form-control" value="0">
                </div>
                <div class="mb-3">
                    <label class="form-label">Alerta de Estoque Baixo (MÃ­nimo)</label>
                    <input type="number" id="minNovo" class="form-control" value="5">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button onclick="salvarNovoProduto()" class="btn btn-success">Confirmar Cadastro</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // ImportaÃ§Ãµes necessÃ¡rias usando a CDN do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Suas credenciais integradas
    const firebaseConfig = {
        apiKey: "AIzaSyA4lwZX_GwaTuMAjmfZB3N-zaF869DV6rE",
        authDomain: "projetoestoqueti.firebaseapp.com",
        databaseURL: "https://projetoestoqueti-default-rtdb.firebaseio.com",
        projectId: "projetoestoqueti",
        storageBucket: "projetoestoqueti.firebasestorage.app",
        messagingSenderId: "787336391551",
        appId: "1:787336391551:web:021e81574a1e0bd4dd084a"
    };

    // Inicializa o Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ReferÃªncia do banco
    const estoqueRef = ref(db, 'estoque/');

    // FunÃ§Ã£o para renderizar a tabela
    function renderizarTabela(dados) {
        const corpo = document.getElementById('tabelaCorpo');
        corpo.innerHTML = '';
        const filtro = document.getElementById('inputBusca').value.toLowerCase();

        if (!dados) return;

        Object.keys(dados).forEach(id => {
            const p = dados[id];
            if (p.nome.toLowerCase().includes(filtro)) {
                const classeAlerta = p.quantidade <= p.estoqueMinimo ? 'baixo-estoque' : '';
                corpo.innerHTML += `
                    <tr class="${classeAlerta}">
                        <td><strong>${p.nome}</strong></td>
                        <td><span class="badge bg-dark badge-qtd">${p.quantidade}</span></td>
                        <td><small class="text-muted">MÃ­n: ${p.estoqueMinimo}</small></td>
                        <td class="text-center">
                            <button onclick="movimentar('${id}', 1)" class="btn btn-success btn-sm btn-movimentacao">+ Entrada</button>
                            <button onclick="movimentar('${id}', -1)" class="btn btn-danger btn-sm btn-movimentacao">- SaÃ­da</button>
                        </td>
                    </tr>
                `;
            }
        });
    }

    // Escuta mudanÃ§as no Firebase e atualiza em tempo real
    onValue(estoqueRef, (snapshot) => {
        renderizarTabela(snapshot.val());
    });

    // FunÃ§Ã£o para salvar novo produto
    window.salvarNovoProduto = () => {
        const nome = document.getElementById('nomeNovo').value;
        const qtd = parseInt(document.getElementById('qtdNovo').value);
        const min = parseInt(document.getElementById('minNovo').value);

        if (nome) {
            const novoRef = push(estoqueRef);
            set(novoRef, {
                nome: nome,
                quantidade: qtd,
                estoqueMinimo: min
            });
            bootstrap.Modal.getInstance(document.getElementById('modalCadastro')).hide();
            document.getElementById('nomeNovo').value = '';
        } else {
            alert("Por favor, preencha o nome do produto.");
        }
    };

    // FunÃ§Ã£o para alterar quantidade (Entrada/SaÃ­da)
    window.movimentar = (id, valor) => {
        const itemRef = ref(db, `estoque/${id}`);
        // Busca o valor atual uma Ãºnica vez para somar/subtrair
        onValue(itemRef, (snapshot) => {
            const atual = snapshot.val().quantidade;
            const novaQtd = atual + valor;
            if (novaQtd < 0) {
                alert("Estoque nÃ£o pode ser negativo!");
                return;
            }
            update(itemRef, { quantidade: novaQtd });
        }, { onlyOnce: true });
    };

    // Listener para o campo de busca
    document.getElementById('inputBusca').addEventListener('input', () => {
        onValue(estoqueRef, (snapshot) => {
            renderizarTabela(snapshot.val());
        }, { onlyOnce: true });
    });

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
